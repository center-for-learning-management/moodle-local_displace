define("local_displace/competency",["exports","jquery","core/ajax","core/notification","core/pending","core/str","core/config"],(function(_exports,_jquery,_ajax,_notification,_pending,Str,_config){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.competenciesaddInit=function(){console.log("competenciesaddInit");(0,_jquery.default)('.coursecompetenciesadd select[name="frameworkid"]').change(loadSelectedFramework),(0,_jquery.default)("#local_displace-framework-container").is(":visible")&&loadSelectedFramework();(0,_jquery.default)(document).on("input",':input[name="competency-search"]',(function(){const searchText=this.value.trim();var $table=getCurrentTable();(0,_jquery.default)("#local_displace-table-search-not-entries-found-message").addClass("hidden"),searchText?($table.find("tr[data-id]").addClass("hidden").removeClass("is-found").removeClass("children-visible").find(".fa-folder").removeClass("fa-folder-open"),$table.find(".shortname").filter(((index,el)=>el.textContent.toLowerCase().includes(searchText.toLowerCase()))).closest("tr").addClass("is-found").each(((index,el)=>{var $tr=(0,_jquery.default)(el);do{$tr.removeClass("hidden"),toggleNode($tr,!0)}while($tr=getParent($tr))})),0==$table.find("tr[data-id]:visible").length&&(0,_jquery.default)("#local_displace-table-search-not-entries-found-message").removeClass("hidden")):0==$table.find("tr[data-id]:visible").length?getCurrentTable().find("tr").filter((function(){return"/0"==getParentPath((0,_jquery.default)(this).attr("data-fullpath"))})).removeClass("hidden").each((function(){toggleNode(this,!0)})):$table.find("tr[data-id]").removeClass("is-found")}))},_exports.setRuleOutcomeOption=function(select){let pendingPromise=new _pending.default,requests=[],coursecompetencyid=(0,_jquery.default)(select).closest("tr").attr("data-id"),ruleoutcome=(0,_jquery.default)(select).val();requests=_ajax.default.call([{methodname:"core_competency_set_course_competency_ruleoutcome",args:{coursecompetencyid:coursecompetencyid,ruleoutcome:ruleoutcome}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:(0,_jquery.default)(select).closest("table").attr("data-courseid"),moduleid:0}}]),requests[1].then((function(){(0,_jquery.default)(select).addClass("displace-alert success"),setTimeout((function(){(0,_jquery.default)(select).removeClass("displace-alert success")}),1e3)})).then(pendingPromise.resolve)},_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_config=_interopRequireDefault(_config);var queue=[],queueActiveItem=!1;const courseid=_config.default.courseId>1?_config.default.courseId:0,useSessionCompetencies=!courseid;let sessionCompetencies=[];const sessionCompetenciesTmp=(0,_jquery.default)(':input[name="session_competencies"]').val();function competencyAddSingle(a){console.log("Add single",a);let id=(0,_jquery.default)(a).closest("tr").attr("data-id");if(useSessionCompetencies)return sessionCompetencies.push(id),(0,_jquery.default)(a).closest("tr").addClass("used"),void(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","));let data={courseid:courseid,competencyid:id};queue.push({methodname:"core_competency_add_competency_to_course",args:data,tr:(0,_jquery.default)(a).closest("tr")}),(0,_jquery.default)(a).closest("tr").addClass("queue-pending"),competencyQueue()}async function competencyRemoveSingle(a,confirmed){if(useSessionCompetencies){let id=(0,_jquery.default)(a).closest("tr").attr("data-id");return sessionCompetencies=sessionCompetencies.filter((value=>value!=id)),(0,_jquery.default)(a).closest("tr").removeClass("used"),void(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","))}if(void 0===confirmed){var shortname=(0,_jquery.default)(a).closest("tr").find(".shortname").html();const s=await get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:single",component:"local_displace",param:{shortname:shortname}},{key:"yes"},{key:"no"}]);_notification.default.confirm(s[0],s[1],s[2],s[3],(function(){competencyRemoveSingle(a,!0)}))}else{console.log("Remove single",a);let id=(0,_jquery.default)(a).closest("tr").attr("data-id"),method="core_competency_remove_competency_from_course",data={courseid:courseid,competencyid:id};queue.push({methodname:method,args:data,tr:(0,_jquery.default)(a).closest("tr")}),(0,_jquery.default)(a).closest("tr").addClass("queue-pending"),competencyQueue()}}function competencyQueue(){if(queueActiveItem)return;if(0==queue.length)return;let item=queue.shift();console.log("Queue Item",item),queueActiveItem=!0,_ajax.default.call([{methodname:item.methodname,args:item.args,done:function(result){(0,_jquery.default)(item.tr).removeClass("queue-pending"),console.log("Results of "+item.methodname,result),result?("core_competency_add_competency_to_course"==item.methodname?(0,_jquery.default)(item.tr).addClass("used"):(0,_jquery.default)(item.tr).removeClass("used"),(0,_jquery.default)(item.tr).addClass("displace-alert success"),setTimeout((function(){(0,_jquery.default)(item.tr).removeClass("displace-alert success")}),1e3)):(0,_jquery.default)(item.tr).addClass("displace-alert danger"),queueActiveItem=!1,competencyQueue()},fail:function(ex){(0,_jquery.default)(item.tr).addClass("displace-alert danger"),queueActiveItem=!1,_notification.default.exception(ex)}}])}function getCurrentTable(){return(0,_jquery.default)("#local_displace-framework-container > *:visible").first()}async function loadSelectedFramework(){var $select=(0,_jquery.default)('.coursecompetenciesadd select[name="frameworkid"]'),selectedText=$select.find("option:selected").text();(0,_jquery.default)("#local_displace-framework-container > *").hide();var frameworkid=$select.val(),$existingFramework=(0,_jquery.default)('#local_displace-framework-container > [data-frameworkid="'+frameworkid+'"]');const s=await get_strings([{key:"competency:loading_framework",component:"local_displace",param:selectedText}]);if($existingFramework.length)$existingFramework.show();else{var $container=(0,_jquery.default)('<div data-frameworkid="'+frameworkid+'">'+s[0]+"</div>").appendTo("#local_displace-framework-container");_jquery.default.get(_config.default.wwwroot+"/local/displace/competency/coursecompetenciesadd.php?action=competency_selector_tree&courseid="+courseid+"&frameworkid="+frameworkid).then((ret=>{console.log("show v2"),$container.html(""),$container.append(ret),function($table){sessionCompetencies.length&&sessionCompetencies.forEach((id=>{$table.find("tr[data-id="+id+"]").addClass("used")}));$table.find("td").each((function(){(0,_jquery.default)(this).children().length?(0,_jquery.default)(this).children().wrapAll('<div class="sliding-wrapper-inner"></div>'):(0,_jquery.default)(this).append('<div class="sliding-wrapper-inner"></div>');var $wrapperInner=(0,_jquery.default)(this).find(".sliding-wrapper-inner");$wrapperInner.wrap('<div class="sliding-wrapper"></div>'),$wrapperInner.css("padding",(0,_jquery.default)(this).css("padding")),$wrapperInner.css("border-top",(0,_jquery.default)(this).css("border-top"))})).css("padding","0").css("border-top","none"),$table.find("tr").filter((function(){return"/0"==getParentPath((0,_jquery.default)(this).attr("data-fullpath"))})).removeClass("hidden").each((function(){toggleNode(this,!0)})),$table.find("tr.used").each((function(){!function(tr){var $tr=(0,_jquery.default)(tr);do{$tr.removeClass("hidden"),toggleNode($tr,!0)}while($tr=getParent($tr))}(this)})),$table.find("tr.has-children .toggler").click((function(e){e.preventDefault(),toggleNode(this,null,!0)})),$table.find(".addsingle").click((function(e){e.preventDefault(),competencyAddSingle(this)})),$table.find(".addmultiple").click((function(e){e.preventDefault(),async function(a){let tr=(0,_jquery.default)(a).closest("tr"),children=(tr.attr("data-id"),getChildren(tr));if(children.length>0){var selectAll=children.filter(":not(.used)").length>0;if(toggleNode(tr,!0,!0),selectAll)children.not(".used").each((function(){competencyAddSingle((0,_jquery.default)(this).find(".addsingle"))}));else{function removeNow(){children.filter(".used").each((function(){competencyRemoveSingle((0,_jquery.default)(this).find(".removesingle"),!0)}))}if(useSessionCompetencies)removeNow();else{let shortname=(0,_jquery.default)(a).closest("tr").find(".shortname").html();const s=await get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:multiple",component:"local_displace",param:{shortname:shortname}},{key:"yes"},{key:"no"}]);_notification.default.confirm(s[0],s[1],s[2],s[3],removeNow)}}useSessionCompetencies&&(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","))}}(this)})),$table.find(".removesingle").click((function(e){e.preventDefault(),competencyRemoveSingle(this)}))}($container.find("table"))}))}}async function get_strings(requests){return Str.get_strings(requests).then((strings=>{var result={};return requests.forEach(((str,i)=>{result[i]=strings[i],result[str.key]=strings[i]})),result}))}function getParentPath(path){if(path)return path.replace(/\/[0-9]+$/,"")}function getParent(tr){var $tr=(0,_jquery.default)(tr);let $parent=(0,_jquery.default)(tr).closest("table").find('tr[data-fullpath="'+getParentPath($tr.attr("data-fullpath"))+'"]');if($parent.length>0)return $parent}function getChildren(tr){var $tr=(0,_jquery.default)(tr);const parentPath=$tr.attr("data-fullpath");return(0,_jquery.default)(tr).closest("table").find('tr[data-fullpath^="'+$tr.attr("data-fullpath")+'/"]').filter((function(){return getParentPath((0,_jquery.default)(this).attr("data-fullpath"))==parentPath}))}function toggleNode(sender){let open=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,animate=arguments.length>2&&void 0!==arguments[2]&&arguments[2],$tr=(0,_jquery.default)(sender).closest("tr"),$table=$tr.closest("table");null==open&&(open=!$tr.hasClass("children-visible"));let close=!open;if(close=close&&$tr.hasClass("children-visible"),open=open&&!$tr.hasClass("children-visible"),close){$tr.removeClass("children-visible").find(".fa-folder").removeClass("fa-folder-open");var $children=$table.find('tr[data-fullpath^="'+$tr.attr("data-fullpath")+'/"]').not(".hidden");if(animate){const height=($wrapper=$children.find(".sliding-wrapper")).outerHeight();$wrapper.css("max-height",height),setTimeout((()=>{$wrapper.css("max-height",0),setTimeout((()=>{$children.addClass("hidden"),$wrapper.css("max-height","")}),500)}),10)}else $children.addClass("hidden")}if(open){$tr.addClass("children-visible").find(".fa-folder").addClass("fa-folder-open");$children=getChildren($tr);var $all=getChildren($tr);do{$children=($children=$children.filter(".children-visible")).map((function(){return $children=getChildren(this).toArray()})),$all=$all.add($children)}while($children.length>0);if($children=$all,animate){var $wrapper=$children.find(".sliding-wrapper");$children.removeClass("hidden");const height=100;$wrapper.css("max-height",10),setTimeout((()=>{$wrapper.css("max-height",height),setTimeout((()=>{$wrapper.css("max-height","")}),500)}),10)}else $children.removeClass("hidden")}}sessionCompetenciesTmp&&(sessionCompetencies=sessionCompetenciesTmp.split(","))}));

//# sourceMappingURL=competency.min.js.map