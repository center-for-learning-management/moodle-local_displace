define("local_displace/competency",["exports","jquery","core/ajax","core/notification","core/pending","core/str","core/config"],(function(_exports,_jquery,_ajax,_notification,_pending,Str,_config){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.competenciesaddInit=function(){false;(0,_jquery.default)('.coursecompetenciesadd select[name="frameworkid"]').change((function(){var $search=(0,_jquery.default)('.local_displace.competency .simplesearchform :input[type="text"]');$search.val()&&$search.val("").trigger("input"),loadSelectedFramework()})),(0,_jquery.default)((function(){(0,_jquery.default)("#local_displace-framework-container").is(":visible")&&loadSelectedFramework()})),(0,_jquery.default)("#local_displace-framework-container").on("click",".has-children .toggler",(function(e){e.preventDefault(),toggleNode(this,null,!0)})).on("click",".addsingle",(function(e){e.preventDefault(),competencyAddSingle(this)})).on("click",".addmultiple",(function(e){e.preventDefault(),async function(a){let tr=(0,_jquery.default)(a).closest(".competency-row"),children=getChildren(tr);if(children.length>0){var selectAll=children.filter(":not(.used)").length>0;if(toggleNode(tr,!0,!0),selectAll)children.not(".used").each((function(){competencyAddSingle((0,_jquery.default)(this).find(".addsingle"))}));else{function removeNow(){children.filter(".used").each((function(){competencyRemoveSingle((0,_jquery.default)(this).find(".removesingle"),!0)}))}if(useSessionCompetencies)removeNow();else{let shortname=(0,_jquery.default)(a).closest(".competency-row").find(".shortname").html();const s=await get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:multiple",component:"local_displace",param:{shortname:shortname}},{key:"yes"},{key:"no"}]);_notification.default.confirm(s[0],s[1],s[2],s[3],removeNow)}}useSessionCompetencies&&(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","))}}(this)})).on("click",".removesingle",(function(e){e.preventDefault(),competencyRemoveSingle(this)})),(0,_jquery.default)(document).on("click",".local_displace.competency .simplesearchform .clear-button",(function(){(0,_jquery.default)(this).closest(".clear-button-wrapper").find(':input[type="text"]').val("").trigger("input")})),(0,_jquery.default)(document).on("input",':input[name="competency-search"]',(function(){const searchText=this.value.trim();var $container=getCurrentFramework();(0,_jquery.default)("#local_displace-table-search-not-entries-found-message").addClass("hidden"),(0,_jquery.default)(this).closest(".clear-button-wrapper").find(".clear-button").toggle(searchText.length>0);var $oldFoundRows=$container.find(".competency-row.is-found");if($oldFoundRows.removeClass("is-found"),searchText.length<=2)getRootContainers($container).removeClass("hidden"),$oldFoundRows.length||($container.find(".competency-row.open").removeClass("open"),getRootContainers($container).each((function(){toggleNode(this,!0)})),$container.find(".competency-row.used").parents(".competency-container").children(".competency-row.has-children").addClass("open"));else{$container.find(".competency-row.open").removeClass("open"),getRootContainers($container).addClass("hidden");var $foundRows=$container.find(".shortname").filter(((index,el)=>el.textContent.toLowerCase().includes(searchText.toLowerCase()))).closest(".competency-row").addClass("is-found").slice(0,1e3);$foundRows.length?($foundRows.parents(".competency-container").children(".competency-row.has-children").addClass("open"),$container.find(".competency-container.hidden").has("> .competency-row.open").removeClass("hidden"),$foundRows.filter(".has-children").addClass("open")):(0,_jquery.default)("#local_displace-table-search-not-entries-found-message").removeClass("hidden")}}))},_exports.setRuleOutcomeOption=function(select){let pendingPromise=new _pending.default,requests=[],coursecompetencyid=(0,_jquery.default)(select).closest(".competency-row").attr("data-id"),ruleoutcome=(0,_jquery.default)(select).val();requests=_ajax.default.call([{methodname:"core_competency_set_course_competency_ruleoutcome",args:{coursecompetencyid:coursecompetencyid,ruleoutcome:ruleoutcome}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:(0,_jquery.default)(select).closest("table").attr("data-courseid"),moduleid:0}}]),requests[1].then((function(){(0,_jquery.default)(select).addClass("displace-alert success"),setTimeout((function(){(0,_jquery.default)(select).removeClass("displace-alert success")}),1e3)})).then(pendingPromise.resolve)},_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_pending=_interopRequireDefault(_pending),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_config=_interopRequireDefault(_config);var queue=[],queueActiveItem=!1;const courseid=_config.default.courseId>1?_config.default.courseId:0,useSessionCompetencies=!courseid;let sessionCompetencies=[];const sessionCompetenciesTmp=(0,_jquery.default)(':input[name="session_competencies"]').val();function competencyAddSingle(a){let id=(0,_jquery.default)(a).closest(".competency-row").attr("data-id");if(useSessionCompetencies)return sessionCompetencies.push(id),(0,_jquery.default)(a).closest(".competency-row").addClass("used"),void(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","));let data={courseid:courseid,competencyid:id};queue.push({methodname:"core_competency_add_competency_to_course",args:data,tr:(0,_jquery.default)(a).closest(".competency-row")}),(0,_jquery.default)(a).closest(".competency-row").addClass("queue-pending"),competencyQueue()}async function competencyRemoveSingle(a,confirmed){if(useSessionCompetencies){let id=(0,_jquery.default)(a).closest(".competency-row").attr("data-id");return sessionCompetencies=sessionCompetencies.filter((value=>value!=id)),(0,_jquery.default)(a).closest(".competency-row").removeClass("used"),void(0,_jquery.default)(':input[name="session_competencies"]').val(sessionCompetencies.join(","))}if(void 0===confirmed){var shortname=(0,_jquery.default)(a).closest(".competency-row").find(".shortname").html();const s=await get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:single",component:"local_displace",param:{shortname:shortname}},{key:"yes"},{key:"no"}]);_notification.default.confirm(s[0],s[1],s[2],s[3],(function(){competencyRemoveSingle(a,!0)}))}else{false;let id=(0,_jquery.default)(a).closest(".competency-row").attr("data-id"),method="core_competency_remove_competency_from_course",data={courseid:courseid,competencyid:id};queue.push({methodname:method,args:data,tr:(0,_jquery.default)(a).closest(".competency-row")}),(0,_jquery.default)(a).closest(".competency-row").addClass("queue-pending"),competencyQueue()}}function competencyQueue(){if(queueActiveItem)return;if(0==queue.length)return;let item=queue.shift();queueActiveItem=!0,_ajax.default.call([{methodname:item.methodname,args:item.args,done:function(result){(0,_jquery.default)(item.tr).removeClass("queue-pending"),result?("core_competency_add_competency_to_course"==item.methodname?(0,_jquery.default)(item.tr).addClass("used"):(0,_jquery.default)(item.tr).removeClass("used"),(0,_jquery.default)(item.tr).addClass("displace-alert success"),setTimeout((function(){(0,_jquery.default)(item.tr).removeClass("displace-alert success")}),1e3)):(0,_jquery.default)(item.tr).addClass("displace-alert danger"),queueActiveItem=!1,competencyQueue()},fail:function(ex){(0,_jquery.default)(item.tr).addClass("displace-alert danger"),queueActiveItem=!1,_notification.default.exception(ex)}}])}function getCurrentFramework(){return(0,_jquery.default)("#local_displace-framework-container > *:visible").first()}async function loadSelectedFramework(){var $select=(0,_jquery.default)('.coursecompetenciesadd select[name="frameworkid"]'),selectedText=$select.find("option:selected").text();const s=await get_strings([{key:"competency:loading_framework",component:"local_displace",param:selectedText}]);(0,_jquery.default)("#local_displace-framework-container > *").hide();var frameworkid=$select.val(),$existingFramework=(0,_jquery.default)('#local_displace-framework-container > [data-frameworkid="'+frameworkid+'"]');if($existingFramework.length)$existingFramework.show();else{var $container=(0,_jquery.default)('<div data-frameworkid="'+frameworkid+'">'+s[0]+"</div>").appendTo("#local_displace-framework-container");_jquery.default.get(_config.default.wwwroot+"/local/displace/competency/coursecompetenciesadd.php?action=competency_selector_tree&courseid="+courseid+"&frameworkid="+frameworkid).then((ret=>{$container.html(""),$container.append(ret),function($container){sessionCompetencies.length&&sessionCompetencies.forEach((id=>{$container.find(".competency-row[data-id="+id+"]").addClass("used")}));false;getRootContainers($container).each((function(){toggleNode(this,!0)})),$container.find(".competency-row.used").parents(".competency-container").children(".competency-row.has-children").addClass("open")}($container)}))}}async function get_strings(requests){return Str.get_strings(requests).then((strings=>{var result={};return requests.forEach(((str,i)=>{result[i]=strings[i],result[str.key]=strings[i]})),result}))}function getRootContainers($container){return $container||($container=getCurrentFramework()),$container.find(".competency-root-container").children(".competency-container")}function getChildren(tr){return(0,_jquery.default)(tr).closest(".competency-container").children(".competency-children").children().children(".competency-row")}function toggleNode(sender){let open=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;var $sender=(0,_jquery.default)(sender);($sender=$sender.is(".competency-container")?$sender.children(".competency-row"):$sender.closest(".competency-row")).toggleClass("open",open)}sessionCompetenciesTmp&&(sessionCompetencies=sessionCompetenciesTmp.split(","))}));

//# sourceMappingURL=competency.min.js.map